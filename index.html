<html>
  <head>
    <!-- https://github.com/blog/1674-github-game-off-ii -->
    <!-- http://craftyjs.com/getting-started/setup.html -->
    <title>Karl</title>
    <style>
      #game {
        margin: 0 auto;
      }

      body {
        background-color: #444;
        padding: 20px;
      }
      </style>
  </head>
  <body>
    <div id="game"></div>

    <script type="text/javascript" src="http://codeorigin.jquery.com/jquery-2.0.3.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/crafty/0.5.4/crafty.js"></script>

    <script>
      Crafty.init(800, 600, 'game');

      Crafty.c("Keyboard", {
        isDown: function (key) {
          if (typeof key === "string") {
            key = Crafty.keys[key];
          }
          return !!Crafty.keydown[key];
        }
      });

      function gen_map() {
        Crafty.background('#444');

        // Builds outer walls
        for (x = 0; x < 800; x++) {
          Crafty.e("2D, Color, DOM, Wall, Solid").attr({ x: x, y: 0, w: 10, h: 10 }).color('#999');
          Crafty.e("2D, Color, DOM, Wall, Solid").attr({ x: x, y: 590, w: 10, h: 10 }).color('#999');
        }

        for (y = 0; y < 600; y++) {
          Crafty.e("2D, Color, DOM, Wall, Solid").attr({ x: 0, y: y, w: 10, h: 10 }).color('#999');
          Crafty.e("2D, Color, DOM, Wall, Solid").attr({ x: 790, y: y, w: 10, h: 10 }).color('#999');
        }

        jQuery.get('/maps/level.1.txt', function(data) {
          var lines = $(data.split('\n'));
          $(lines).each(function(y) {
            $(lines[y].split('')).each(function(x) {
              if (lines[y].split('')[x] == '#') {
                Crafty.e("2D, Color, DOM, Wall, Solid").attr({ x: (x*10), y: (y*10), w: 10, h: 10 }).color('#999');
              }
            });
          });
        }, "text");
      }

      gen_map();

      // Dot
      Crafty.e("2D, DOM, Color, Fourway, Collision")
        .color('#ccff66')
        .attr({ x: 10, y: 10, w: 10, h: 10 })
        .fourway(4)
        .collision()
        .bind('EnterFrame', function () {
          // This is constantly firing, 24/7
        })
        .bind('Moved', function(from) {
          if(this.hit('Wall')) {
            this.attr({x: from.x, y: from.y});
          }
        });
    </script>
  </body>
</html>
